name: FornoPizza_S3 Build & Release

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build Firmware ESP32-S3
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Cache Arduino CLI & librerie ──────────────────────────
      - name: Cache Arduino CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: arduino-esp32s3-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            arduino-esp32s3-

      # ── 3. Installa Arduino CLI ───────────────────────────────────
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # ── 4. Aggiungi board ESP32 & installa core ───────────────────
      - name: Install ESP32 core
        run: |
          arduino-cli core update-index \
            --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core install esp32:esp32 \
            --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      # ── 5. Installa librerie ──────────────────────────────────────
      # LovyanGFX >= 1.2.x include Panel_RGB e Bus_RGB per ESP32-S3
      # NON installare TFT_eSPI né XPT2046_Touchscreen (rimossi nel porting)
      - name: Install libraries
        run: |
          arduino-cli lib install \
            "LovyanGFX" \
            "lvgl@8.4.0" \
            "MAX6675 library" \
            "PID" \
            "PubSubClient" \
            "ArduinoJson"

      # ── 6. Patch lv_conf.h ───────────────────────────────────────
      - name: Patch lv_conf.h
        run: |
          LV_CONF=$(find ~/.arduino15 ~/Arduino/libraries -name "lv_conf.h" 2>/dev/null | head -1)
          if [ -n "$LV_CONF" ]; then
            echo "Patching: $LV_CONF"
            sed -i 's/^#define LV_MEM_POOL_INCLUDE/\/\/#define LV_MEM_POOL_INCLUDE/' "$LV_CONF" || true
            echo "Patch completata"
          else
            echo "lv_conf.h non trovato -- skip patch"
          fi

      # ── 7. Usa lv_conf.h del progetto (se presente nella repo) ───
      - name: Use project lv_conf.h
        run: |
          if [ -f "lv_conf.h" ]; then
            LV_DIR=$(find ~/.arduino15 ~/Arduino/libraries -maxdepth 3 -name "lvgl" -type d 2>/dev/null | head -1)
            if [ -n "$LV_DIR" ]; then
              cp lv_conf.h "$LV_DIR/../lv_conf.h"
              echo "lv_conf.h copiato in: $LV_DIR/../lv_conf.h"
            fi
          fi

      # ── 8. Compila ────────────────────────────────────────────────
      # Board: ESP32-S3-WROOM-1-N16R8 (JC4827W543C monta N16R8)
      #   CPUFreq:         240 MHz
      #   FlashSize:       16 MB  (N16R8)
      #   FlashMode:       QIO
      #   FlashFreq:       80 MHz
      #   PartitionScheme: default_16MB  (due OTA da ~6 MB + SPIFFS)
      #   PSRAM:           OPI PSRAM 8 MB  (necessario per framebuffer RGB)
      #   USBMode:         hwcdc  (USB-CDC nativa ESP32-S3)
      #   EventsCore:      Core 1
      #   ArduinoCore:     Core 1
      #
      # NOTA PSRAM OPI: GPIO 33-37 riservati internamente — NON usarli.
      # Il display RGB usa la periferica LCD_CAM dell'ESP32-S3 via Bus_RGB.
      - name: Compile sketch
        run: |
          arduino-cli compile \
            --fqbn "esp32:esp32:esp32s3:CPUFreq=240,FlashSize=16M,FlashMode=qio,FlashFreq=80,PartitionScheme=default_16MB,PSRAM=opi,USBMode=hwcdc,EventsCore=1,ArduinoCore=1" \
            --output-dir ./build \
            --warnings default \
            ./FornoPizza_S3

      # ── 9. Mostra dimensione binari ─────────────────────────────
      - name: Show firmware size
        run: |
          echo "=== Firmware generati ==="
          ls -lh ./build/*.bin 2>/dev/null || echo "Nessun .bin trovato"

      # ── 10. Upload artifact ──────────────────────────────────────
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: FornoPizza_S3-firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: |
            ./build/*.bin
            ./build/*.elf
          retention-days: 30

  # ════════════════════════════════════════════════════════════════
  #  RELEASE — si attiva solo su tag: git tag v1.0 && git push --tags
  # ════════════════════════════════════════════════════════════════
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: FornoPizza_S3-firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: ./release

      - name: Rinomina binari con versione
        run: |
          TAG="${{ github.ref_name }}"
          for f in ./release/*.bin; do
            mv "$f" "./release/FornoPizza_S3_${TAG}_$(basename $f)"
          done
          echo "=== File release ===" && ls -lh ./release/

      - name: Crea Release GitHub
        uses: softprops/action-gh-release@v2
        with:
          name: "FornoPizza S3 ${{ github.ref_name }}"
          body: |
            ## FornoPizza S3 ${{ github.ref_name }}

            ### Hardware target
            | Componente | Dettaglio |
            |---|---|
            | MCU | ESP32-S3-WROOM-1-N16R8 |
            | Display | 4.3" ST7701S RGB 480×272 (Bus_RGB parallelo) |
            | Touch | GT911 I2C capacitivo |
            | PSRAM | OPI 8 MB (GPIO 33-37 riservati) |
            | Flash | 16 MB QIO 80 MHz |
            | Partition | default_16MB — 2×6 MB OTA + SPIFFS |
            | CPU | 240 MHz (WiFi/BT) |
            | Events / Arduino | Core 1 |

            ### Flash iniziale via USB
            ```bash
            esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 \
              write_flash -z 0x10000 FornoPizza_S3_${{ github.ref_name }}_*.bin
            ```

            ### Aggiornamento OTA
            Usa l'interfaccia web integrata del forno (WiFi → OTA Update).
          files: ./release/*.bin
          draft: false
          prerelease: false