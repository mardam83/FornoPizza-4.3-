name: FornoPizza Build & Release

on:
  push:
    branches: [ "**" ]        # compila ad ogni push su qualsiasi branch
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Cache Arduino CLI & librerie ──────────────────────────
      - name: Cache Arduino CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: arduino-esp32-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            arduino-esp32-

      # ── 3. Installa Arduino CLI ───────────────────────────────────
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # ── 4. Aggiungi board ESP32 & installa core ───────────────────
      - name: Install ESP32 core
        run: |
          arduino-cli core update-index \
            --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core install esp32:esp32 \
            --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      # ── 5. Installa librerie ──────────────────────────────────────
      - name: Install libraries
        run: |
          arduino-cli lib install \
            "LovyanGFX" \
            "lvgl@8.3.11" \
            "MAX6675 library" \
            "PID" \
            "PubSubClient" \
            "ArduinoJson"

      # ── 6. Patch lv_conf.h — ERRORI NOTI ─────────────────────────
      - name: Patch lv_conf.h (errori noti LVGL)
        run: |
          LV_CONF=$(find ~/.arduino15 ~/Arduino/libraries -name "lv_conf.h" 2>/dev/null | head -1)
          if [ -n "$LV_CONF" ]; then
            echo "Patching: $LV_CONF"
            sed -i 's/^#define LV_MEM_POOL_INCLUDE/\/\/#define LV_MEM_POOL_INCLUDE/' "$LV_CONF" || true
            sed -i "s/#define LV_TXT_COLOR_CMD\s*'#'/#define LV_TXT_COLOR_CMD \"#\"/" "$LV_CONF" || true
            echo "Patch completata"
          else
            echo "lv_conf.h non trovato -- skip patch"
          fi

      # ── 7. Usa lv_conf.h del progetto (se presente nella repo) ───
      - name: Use project lv_conf.h (if present)
        run: |
          if [ -f "lv_conf.h" ]; then
            LV_DIR=$(find ~/.arduino15 ~/Arduino/libraries -maxdepth 3 -name "lvgl" -type d 2>/dev/null | head -1)
            if [ -n "$LV_DIR" ]; then
              cp lv_conf.h "$LV_DIR/../lv_conf.h"
              echo "lv_conf.h copiato in: $LV_DIR/../lv_conf.h"
            fi
          fi

      # ── 8. Compila ────────────────────────────────────────────────
      # Impostazioni board (ESP32-S3-WROOM-1-N4R8):
      #   CPU Frequency:    240 MHz (WiFi/BT)
      #   Flash Frequency:  80 MHz QIO 4 MB
      #   Partition:        Minimal SPIFFS (1.9 MB APP + OTA / 128 KB SPIFFS)
      #   PSRAM:            OPI PSRAM  ← N4R8 usa PSRAM OPI (8 MB)
      #   Events / Arduino: Core 1
      #
      # NOTA: su N4R8 la PSRAM è OPI (Octal SPI) — i GPIO 33-37 sono
      # riservati internamente dal bus OPI e NON devono essere usati.
      - name: Compile sketch
        run: |
          arduino-cli compile \
            --fqbn "esp32:esp32:esp32s3:CPUFreq=240,FlashFreq=80,FlashMode=qio,FlashSize=4M,PartitionScheme=min_spiffs,PSRAM=opi,EventsCore=1,ArduinoCore=1" \
            --output-dir ./build \
            --warnings default \
            .

      # ── 9. Mostra dimensione binari ──────────────────────────────
      - name: Show firmware size
        run: |
          echo "=== Firmware generati ==="
          ls -lh ./build/*.bin 2>/dev/null || echo "Nessun .bin trovato"

      # ── 10. Upload artifact ──────────────────────────────────────
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: FornoPizza-firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: |
            ./build/*.bin
            ./build/*.elf
          retention-days: 30

  # ════════════════════════════════════════════════════════════════
  #  RELEASE -- si attiva solo su tag: git tag v1.0 && git push --tags
  # ════════════════════════════════════════════════════════════════
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: FornoPizza-firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: ./release

      - name: Rinomina binari con versione
        run: |
          TAG="${{ github.ref_name }}"
          for f in ./release/*.bin; do
            mv "$f" "./release/FornoPizza_${TAG}_$(basename $f)"
          done
          echo "=== File release ===" && ls -lh ./release/

      - name: Crea Release GitHub
        uses: softprops/action-gh-release@v2
        with:
          name: "FornoPizza ${{ github.ref_name }}"
          body: |
            ## FornoPizza ${{ github.ref_name }}

            ### Flash iniziale via USB
            ```bash
            esptool.py --chip esp32s3 --port /dev/ttyUSB0 --baud 921600 \
              write_flash -z 0x10000 FornoPizza_${{ github.ref_name }}_*.bin
            ```

            ### Aggiornamento OTA
            Usa l'interfaccia web integrata del forno (WiFi → OTA Update).

            | Parametro | Valore |
            |---|---|
            | MCU | ESP32-S3-WROOM-1-N4R8 |
            | CPU | 240 MHz (WiFi/BT) |
            | Flash | 80 MHz QIO 4 MB |
            | Partition | Minimal SPIFFS — 1.9 MB APP + OTA + 128 KB SPIFFS |
            | PSRAM | OPI 8 MB |
            | Display buffer | Double full framebuffer PSRAM (2 × 255 KB) + DMA SPI |
            | Events / Arduino | Core 1 |
          files: ./release/*.bin
          draft: false
          prerelease: false
