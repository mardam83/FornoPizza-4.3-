name: FornoPizza Build & Release

on:
  push:
    branches: [ "**" ]        # compila ad ogni push su qualsiasi branch
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    name: Build Firmware
    runs-on: ubuntu-latest

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4

      # ── 2. Cache Arduino CLI & librerie ──────────────────────────
      - name: Cache Arduino CLI
        uses: actions/cache@v4
        with:
          path: |
            ~/.arduino15
            ~/Arduino/libraries
          key: arduino-esp32-${{ hashFiles('.github/workflows/build.yml') }}
          restore-keys: |
            arduino-esp32-

      # ── 3. Installa Arduino CLI ───────────────────────────────────
      - name: Install Arduino CLI
        uses: arduino/setup-arduino-cli@v2

      # ── 4. Aggiungi board ESP32 & installa core ───────────────────
      - name: Install ESP32 core
        run: |
          arduino-cli core update-index \
            --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json
          arduino-cli core install esp32:esp32 \
            --additional-urls https://raw.githubusercontent.com/espressif/arduino-esp32/gh-pages/package_esp32_index.json

      # ── 5. Installa librerie ──────────────────────────────────────
      # Nomi esatti da Arduino Library Manager, verificati sugli #include del progetto:
      #   max6675.h        -> "MAX6675 library"  (by Rob Tillaart)
      #   PID_v1.h         -> "PID"              (by Brett Beauregard)
      #   PID_AutoTune_v0  -> "PID_AutoTune_v0"  (by Brett Beauregard)
      #   PubSubClient.h   -> "PubSubClient"     (by Nick O'Leary)
      #   ArduinoJson.h    -> "ArduinoJson"      (by Benoit Blanchon)
      - name: Install libraries
        run: |
          arduino-cli lib install \
            "lvgl@8.3.11" \
            "TFT_eSPI" \
            "XPT2046_Touchscreen" \
            "MAX6675 library" \
            "PID" \
            "PubSubClient" \
            "ArduinoJson"

      # ── 6. Patch lv_conf.h — ERRORI NOTI ─────────────────────────
      # - #define LV_MEM_POOL_INCLUDE ""  -> va COMMENTATA (errore compiler)
      # - #define LV_TXT_COLOR_CMD "#"    -> virgolette DOPPIE, non singole
      - name: Patch lv_conf.h (errori noti LVGL)
        run: |
          LV_CONF=$(find ~/.arduino15 ~/Arduino/libraries -name "lv_conf.h" 2>/dev/null | head -1)
          if [ -n "$LV_CONF" ]; then
            echo "Patching: $LV_CONF"
            sed -i 's/^#define LV_MEM_POOL_INCLUDE/\/\/#define LV_MEM_POOL_INCLUDE/' "$LV_CONF" || true
            sed -i "s/#define LV_TXT_COLOR_CMD\s*'#'/#define LV_TXT_COLOR_CMD \"#\"/" "$LV_CONF" || true
            echo "Patch completata"
          else
            echo "lv_conf.h non trovato -- skip patch"
          fi

      # ── 7. Usa lv_conf.h del progetto (se presente nella repo) ───
      # Il lv_conf.h del progetto ha gia LV_MEM_POOL_INCLUDE commentata
      # e LV_TXT_COLOR_CMD con virgolette doppie -- sovrascrive quello LVGL
      - name: Use project lv_conf.h (if present)
        run: |
          if [ -f "lv_conf.h" ]; then
            LV_DIR=$(find ~/.arduino15 ~/Arduino/libraries -maxdepth 3 -name "lvgl" -type d 2>/dev/null | head -1)
            if [ -n "$LV_DIR" ]; then
              cp lv_conf.h "$LV_DIR/../lv_conf.h"
              echo "lv_conf.h copiato in: $LV_DIR/../lv_conf.h"
            fi
          fi

      # ── 8. Usa User_Setup.h del progetto per TFT_eSPI ────────────
      - name: Use project User_Setup.h (if present)
        run: |
          if [ -f "User_Setup.h" ]; then
            TFT_DIR=$(find ~/.arduino15 ~/Arduino/libraries -maxdepth 3 -name "TFT_eSPI" -type d 2>/dev/null | head -1)
            if [ -n "$TFT_DIR" ]; then
              cp User_Setup.h "$TFT_DIR/User_Setup.h"
              echo "User_Setup.h copiato in: $TFT_DIR"
            fi
          fi

      # ── 9. Compila ────────────────────────────────────────────────
      # Impostazioni board da Arduino IDE (screenshot):
      #   CPU Frequency:    240MHz (WiFi/BT)
      #   Flash Frequency:  80MHz
      #   Flash Mode:       QIO
      #   Flash Size:       4MB (32Mb)
      #   Partition:        Minimal SPIFFS (1.9MB APP with OTA / 128KB SPIFFS)
      #   PSRAM:            Disabled
      #   Events Run On:    Core 1
      #   Arduino Runs On:  Core 1
      - name: Compile sketch
        run: |
          arduino-cli compile \
            --fqbn "esp32:esp32:esp32:CPUFreq=240,FlashFreq=80,FlashMode=qio,FlashSize=4M,PartitionScheme=min_spiffs,PSRAM=disabled,EventsCore=1" \
            --output-dir ./build \
            --warnings default \
            .

      # ── 10. Mostra dimensione binari ──────────────────────────────
      - name: Show firmware size
        run: |
          echo "=== Firmware generati ==="
          ls -lh ./build/*.bin 2>/dev/null || echo "Nessun .bin trovato"

      # ── 11. Upload artifact ───────────────────────────────────────
      - name: Upload firmware artifact
        uses: actions/upload-artifact@v4
        with:
          name: FornoPizza-firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: |
            ./build/*.bin
            ./build/*.elf
          retention-days: 30

  # ════════════════════════════════════════════════════════════════
  #  RELEASE -- si attiva solo su tag tipo: git tag v1.0 && git push --tags
  # ════════════════════════════════════════════════════════════════
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Download firmware artifacts
        uses: actions/download-artifact@v4
        with:
          name: FornoPizza-firmware-${{ github.ref_name }}-${{ github.run_number }}
          path: ./release

      - name: Rinomina binari con versione
        run: |
          TAG="${{ github.ref_name }}"
          for f in ./release/*.bin; do
            mv "$f" "./release/FornoPizza_${TAG}_$(basename $f)"
          done
          echo "=== File release ===" && ls -lh ./release/

      - name: Crea Release GitHub
        uses: softprops/action-gh-release@v2
        with:
          name: "FornoPizza ${{ github.ref_name }}"
          body: |
            ## FornoPizza ${{ github.ref_name }}

            ### Flash iniziale via USB
            ```bash
            esptool.py --chip esp32 --port /dev/ttyUSB0 --baud 921600 \
              write_flash -z 0x10000 FornoPizza_${{ github.ref_name }}_*.bin
            ```

            ### Aggiornamento OTA
            Usa l'interfaccia web integrata del forno (WiFi -> OTA Update).

            | Parametro | Valore |
            |---|---|
            | CPU | 240 MHz (WiFi/BT) |
            | Flash | 80 MHz QIO 4 MB |
            | Partition | Minimal SPIFFS - 1.9 MB APP + OTA + 128 KB SPIFFS |
            | PSRAM | Disabled |
            | Events / Arduino | Core 1 |
          files: ./release/*.bin
          draft: false
          prerelease: false